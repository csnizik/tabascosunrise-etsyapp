name: "Copilot Setup Steps"

# Automatically run when setup changes, allowing validation
# Also allows manual testing through repository Actions tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    name: Setup Environment for Copilot Coding Agent
    runs-on: ubuntu-latest

    # Timeout to prevent runaway processes
    timeout-minutes: 15

    steps:
      # ================================================================
      # STEP 1: Repository Setup
      # ================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      # ================================================================
      # STEP 2: Node.js Environment Setup
      # ================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # LTS version for stability
          cache: 'npm'

      - name: Verify Node.js and npm versions
        run: |
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "npx version: $(npx --version)"

      # ================================================================
      # STEP 3: Install Dependencies
      # ================================================================
      - name: Clean install dependencies
        run: |
          echo "Installing dependencies from package-lock.json..."
          npm ci
        env:
          NODE_ENV: development

      - name: Verify critical dependencies
        run: |
          echo "Verifying Next.js installation..."
          npx next --version || (echo "ERROR: Next.js not installed" && exit 1)

          echo "Verifying TypeScript installation..."
          npx tsc --version || (echo "ERROR: TypeScript not installed" && exit 1)

          echo "Verifying Playwright installation..."
          npx playwright --version || (echo "ERROR: Playwright not installed" && exit 1)

          echo "All critical dependencies verified ✓"

      # ================================================================
      # STEP 4: Install Playwright Browsers
      # ================================================================
      - name: Install Playwright browsers
        run: |
          echo "Installing Playwright browser binaries..."
          npx playwright install --with-deps chromium
        env:
          PLAYWRIGHT_BROWSERS_PATH: 0  # Use system location

      - name: Verify Playwright browser installation
        run: |
          echo "Verifying Chromium installation..."
          npx playwright install --dry-run chromium

      # ================================================================
      # STEP 5: Environment Configuration
      # ================================================================
      - name: Create test environment file
        run: |
          echo "Creating .env.test for test environment..."
          cat > .env.test << 'EOF'
          # Test Environment Variables
          # These are safe mock values for testing only

          # Etsy API (Mock values for tests)
          ETSY_API_KEY=test_api_key_do_not_use_in_production
          ETSY_SHARED_SECRET=test_shared_secret
          ETSY_REDIRECT_URI=http://localhost:3000/api/auth/etsy/callback
          ETSY_SCOPES=listings_r shops_r

          # Edge Config (Mock - tests should mock Edge Config responses)
          EDGE_CONFIG=https://edge-config.vercel.com/test
          EDGE_CONFIG_ID=ecfg_test
          EDGE_CONFIG_TOKEN=test_token

          # Blob Storage (Mock)
          BLOB_READ_WRITE_TOKEN=test_blob_token

          # Security
          CRON_SECRET=test_cron_secret_for_testing_only

          # Test mode flag
          NODE_ENV=test
          EOF

          echo ".env.test created successfully ✓"

      - name: Verify environment file
        run: |
          if [ ! -f .env.test ]; then
            echo "ERROR: .env.test not created"
            exit 1
          fi
          echo "Environment file verified ✓"

      # ================================================================
      # STEP 6: TypeScript Compilation Check
      # ================================================================
      - name: TypeScript type checking
        run: |
          echo "Running TypeScript compiler..."
          npx tsc --noEmit --pretty
        continue-on-error: false

      - name: TypeScript build check
        run: |
          echo "Building TypeScript project..."
          npm run build
        env:
          SKIP_ENV_VALIDATION: true
        continue-on-error: false

      # ================================================================
      # STEP 7: Linting and Code Quality
      # ================================================================
      - name: ESLint check
        run: |
          echo "Running ESLint..."
          npm run lint || echo "WARNING: Linting issues found"
        continue-on-error: true

      # ================================================================
      # STEP 8: Start Development Server (Background)
      # ================================================================
      - name: Start Next.js development server
        run: |
          echo "Starting Next.js dev server in background..."
          npm run dev &
          echo $! > .dev-server.pid
          echo "Dev server PID: $(cat .dev-server.pid)"
        env:
          PORT: 3000

      - name: Wait for development server to be ready
        run: |
          echo "Waiting for dev server at http://localhost:3000..."
          timeout 120 bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; done' || (
            echo "ERROR: Dev server failed to start within 120 seconds"
            if [ -f .dev-server.pid ]; then
              echo "Dev server logs:"
              jobs -l
            fi
            exit 1
          )
          echo "Development server is ready ✓"

      - name: Verify critical routes are accessible
        run: |
          echo "Checking root route..."
          curl -f http://localhost:3000 > /dev/null || (echo "ERROR: Root route failed" && exit 1)

          echo "Checking API health (if exists)..."
          curl -f http://localhost:3000/api/health 2>/dev/null || echo "No health endpoint (OK)"

          echo "All accessible routes verified ✓"

      # ================================================================
      # STEP 9: Run Unit Tests (if they exist)
      # ================================================================
      - name: Run unit tests
        run: |
          if [ -d "tests" ] || [ -d "__tests__" ] || [ -d "src/__tests__" ]; then
            echo "Running unit tests..."
            npm test -- --passWithNoTests || echo "WARNING: Some tests failed"
          else
            echo "No unit tests found (OK for early development)"
          fi
        continue-on-error: true

      # ================================================================
      # STEP 10: Run Playwright E2E Tests
      # ================================================================
      - name: Run Playwright tests
        run: |
          if [ -d "tests/e2e" ] || [ -d "e2e" ] || [ -d "playwright" ]; then
            echo "Running Playwright e2e tests..."
            npx playwright test --reporter=list,html
          else
            echo "No Playwright tests found yet"
            echo "Copilot should create tests in tests/e2e/ directory"
          fi
        env:
          CI: true
        continue-on-error: true

      # ================================================================
      # STEP 11: Upload Test Artifacts
      # ================================================================
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Playwright screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-screenshots
          path: tests/screenshots/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 30

      # ================================================================
      # STEP 12: Build Production Bundle
      # ================================================================
      - name: Build production bundle
        run: |
          echo "Building production bundle..."
          npm run build
        env:
          NODE_ENV: production
          SKIP_ENV_VALIDATION: true

      - name: Verify build output
        run: |
          if [ -d ".next" ]; then
            echo "Build output directory exists ✓"
            echo "Build size:"
            du -sh .next
          else
            echo "ERROR: Build output directory not found"
            exit 1
          fi

      # ================================================================
      # STEP 13: Security Checks
      # ================================================================
      - name: Check for security vulnerabilities
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=high || echo "WARNING: Security vulnerabilities found"
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          echo "Checking for accidentally committed secrets..."

          # Check for common secret patterns
          if grep -r "ETSY_API_KEY.*=.*[a-z0-9]\{20,\}" src/ 2>/dev/null; then
            echo "ERROR: Potential API key found in source code"
            exit 1
          fi

          if grep -r "Bearer [a-zA-Z0-9_-]\{20,\}" src/ 2>/dev/null; then
            echo "ERROR: Potential bearer token found in source code"
            exit 1
          fi

          echo "No secrets detected in source code ✓"

      # ================================================================
      # STEP 14: Cleanup
      # ================================================================
      - name: Stop development server
        if: always()
        run: |
          if [ -f .dev-server.pid ]; then
            PID=$(cat .dev-server.pid)
            echo "Stopping dev server (PID: $PID)..."
            kill $PID 2>/dev/null || echo "Dev server already stopped"
            rm .dev-server.pid
          fi

      - name: Cleanup test environment
        if: always()
        run: |
          echo "Cleaning up test artifacts..."
          rm -f .env.test
          echo "Cleanup complete ✓"

      # ================================================================
      # STEP 15: Summary Report
      # ================================================================
      - name: Generate setup summary
        if: always()
        run: |
          echo "=========================================="
          echo "Copilot Setup Steps - Summary Report"
          echo "=========================================="
          echo ""
          echo "✓ Repository checked out"
          echo "✓ Node.js $(node --version) configured"
          echo "✓ Dependencies installed"
          echo "✓ Playwright browsers installed"
          echo "✓ TypeScript compilation successful"
          echo "✓ Development server verified"
          echo "✓ Production build successful"
          echo ""
          echo "Environment is ready for Copilot Coding Agent"
          echo "=========================================="

# ================================================================
# PLAYWRIGHT CONFIGURATION REFERENCE
# ================================================================
# This workflow expects a playwright.config.ts in the repository root
# Example minimal config:
#
# import { defineConfig } from '@playwright/test';
#
# export default defineConfig({
#   testDir: './tests/e2e',
#   use: {
#     baseURL: 'http://localhost:3000',
#     screenshot: 'only-on-failure',
#     video: 'retain-on-failure',
#   },
#   webServer: {
#     command: 'npm run dev',
#     port: 3000,
#     reuseExistingServer: !process.env.CI,
#   },
# });

# ================================================================
# COPILOT AGENT NOTES
# ================================================================
# When Copilot Coding Agent runs, it will:
# 1. Execute these setup steps automatically in GitHub Actions
# 2. Have a fully configured environment with:
#    - Node.js and all dependencies installed
#    - Development server running
#    - Playwright ready for testing
#    - TypeScript compilation verified
#    - Linting checked
# 3. Be able to run tests and capture screenshots
# 4. Validate that code changes don't break the build
#
# This ensures Copilot can:
# - Write code that compiles
# - Run tests to verify functionality
# - Capture screenshots for UI changes
# - Detect issues before PR review
